## 什么是微前端

> Micro Frontends背后的想法是将网站或Web应用视为独立团队拥有的功能组合。每个团队都有一个独特的业务或任务领域，做他们关注和专注的事情。团队是跨职能的，从数据库到用户界面开发端到端的功能

我们知道，后端有微服务的概念；它是一种开发技术，允许开发人员为平台的不同部分进行独立部署，而不会损害其他部分。独立部署的能力允许他们构建孤立或松散耦合的服务。

![waFVSO.png](https://s1.ax1x.com/2020/09/12/waFVSO.png)

从上面的图可以看出，后端服务分成了许多服务模块；但是UI部分却是一个整体。

所以我们参考微服务的概念，将这个理念放到浏览器端：将单页面前端应用由单一的单体应用转变为多个小型前端应用聚合为一的应用。

![waRDIK.png](https://s1.ax1x.com/2020/09/12/waRDIK.png)

## 为什么使用微前端

现有的开发背景下，我们前端开发人员一直都在开发单体应用；以Vue为例，我们使用脚手架生成项目目录以及相关的构建工具和库，最终开发完毕打包上线。如果你有好几个团队一起协同，那么需要大家一起协商好技术栈（比如Vue）,开发完每一个功能模块，提交代码到仓库，合并冲突等等，大概就是这个流程。

### 考虑两个业务场景

- 随着业务的增加，我们前端的页面增加，包也随着增大

  目前在笔者我自己的项目组就遇到了，据我初略统计，目前整个项目页面数量在50+，包含了机构养老、健康档案、社区居家服务等几个大模块，如果借助微前端的话可以将几个模块拆解出来，进行解耦。

- 如果考虑外界的模块或完整的Web应用集成进来

  项目组目前打算集成另外厂商开发的慢病管理平台。这个场景我估计大多数拿到这个需求的时候首先想到的就是集成代码到自有的项目里面，但是如果是用的相同的技术栈还好，如果是不同的技术栈怎么办。

![wab4PA.png](https://s1.ax1x.com/2020/09/12/wab4PA.png)

### 微前端的特点

运用微前端我们可以解决上面业务场景的问题，它包含以下三个特点

- 单个前端部分可独立开发、测试和部署
- 无需重新构建即可添加、移除或替换单个前端部分
- 不同的前端部分可使用不同的技术构建

![wazcAf.png](https://s1.ax1x.com/2020/09/12/wazcAf.png)



## 微前端需要解决的业务问题以及如何实现

### 技术栈无关

个人觉得这个算是微前端的核心所在，如果技术栈是相关的话，我觉得微前端的意义并不大；

![wojtxO.png](https://s1.ax1x.com/2020/09/20/wojtxO.png)

以上图为例，如果是技术栈相关的话，我们的微应用（项目B、项目C）最终还是要统一到主应用的技术栈（Vue）。这样感觉跟统一技术栈并集成为一个单体应用的区别不是特别大。

技术栈无关提现的价值

- 不限制技术栈，接入广泛
- 向后兼容：可接入旧应用
- 向前兼容：可接入新技术、面向未来

### 应用加载与切换

- 路由处理
- 应用加载处理
- 应用入口选择

### 应用的隔离与通讯

- JS的隔离
- CSS样式的隔离
- 父子、子子应用的通讯

### 解决方案

- iframe

  iframe应该都熟悉，如果我们需要在我们自己的页面接入一个第三方页面，使用iframe标签即可，iframe天生的提供了CSS样式隔离、JS隔离的特性，但是这个特性也导致了它的局限性，比如隔离性无法突破，应用间的上下文无法共享。

- single-spa

  这个算是微前端的基石，目前很多微前端框架都或多或少的使用过它的特性，比如qiankun微前端框架。但是single-spa在微应用接入主应用时比较繁琐，同时框架本身不提供样式和JS隔离，需要自己处理。

- qiankun（乾坤）

  qiankun 是一个基于 single-spa 的微前端实现库，旨在帮助大家能更简单、无痛的构建一个生产可用微前端架构系统。qiankun是蚂蚁金融科技出品的微前端框架。算是比较完整、并且在蚂蚁内部大量运用的微前端解决方案。

### qiankun

接下来重点介绍以下qiankun框架，看看qiankun对上面几个问题的解决方案

#### 应用路由

一般来说我的微前端应用肯定会有一个主应用，这个主应用负责接入各个微应用，那么当我们在访问到微应用时，我们需要对路由做相应的处理，否则会出现404等未知的错误。

[![wTei1e.png](https://s1.ax1x.com/2020/09/20/wTei1e.png)](https://imgchr.com/i/wTei1e)

qinkun在路由处理方面直接采用了single-spa的原始方案，包括路由劫持、路由切换、路由加载。

#### 应用接入

##### 子应用实现生命周期钩子

qiankun遵从的是协议接入，这样就做到了技术无关；qiankun的思想是运用生命周期钩子的原理，只要你的子应用实现了bootstrap、mount、unmount三个钩子，那么qiankun就知道该如何去加载这个子应用。

我们需要在子应用的入口实现这三个钩子

```
export async function bootstrap() {
  console.log("vue app bootstraped");
}

export async function mount(props) {
  console.log("props from main framework", props.data);
  render(props);
}

export async function unmount() {
  console.log("vue app unmounted");
}
```

##### 应用的组合时机与应用入口的选择

qiankun在组合上选择的是运行时组合，这儿的组合就是，在你开发过程你肯定会有一个主应用和若干个子应用，那么你在开发完毕后要把这些应用组合为一个微应用，你有两种方式

- 构建时

  把主应用和子应用打包到一起，这种好处是可以进行做公共依赖的提取，但是这样把主子应用耦合到了一起，不太灵活。

- 运行时

  动态的去加载子应用，这样子应用和主应用是独立构建的，进行了解耦处理，问题就是在运行时会有加载损耗。

在应用入口的选择上，qiankun选择的是HTML Entry的方式，在加载子应用的时候，我们这里了解到，在加载子应用时需要提供一份资源列表，比如JS、CSS等等。选择HTML的方式是因为，这样只需要提供一份HTML文件即可，通过link、script等标签来提供子应用需要用到的元信息。

- HTML

  HTML作为子应用入口，解耦更加彻底，主子应用独立开发、独立部署，缺点就是多了HTML的请求，有损耗，并且无法做整体的构建优化。

- JS

  JS作为子应用入口，便于构建优化，缺点就是依赖主应用的挂载节点，打包整体体积随着时间推移会越来越大。

#### JS隔离

qiankun实现隔离使用的是JS沙箱的方式，也就是为子应用建立一个内部沙箱环境，让子应用在沙箱里面运行。

沙箱的实现